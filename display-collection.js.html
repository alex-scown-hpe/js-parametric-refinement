<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>HP Autonomy JS Parametric Refinement Source: display-collection.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">HP Autonomy JS Parametric Refinement</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-display-collection.html">display-collection</a>
						</li>
						
						<li>
							<a href="module-selected-values-collection.html">selected-values-collection</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-display-collection-DisplayCollection.html">display-collection~DisplayCollection</a>
						</li>
						
						<li>
							<a href="module-display-collection-DisplayModel.html">display-collection~DisplayModel</a>
						</li>
						
						<li>
							<a href="module-display-collection-ValuesCollection.html">display-collection~ValuesCollection</a>
						</li>
						
						<li>
							<a href="module-selected-values-collection-SelectedValuesCollection.html">selected-values-collection~SelectedValuesCollection</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: display-collection.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/*
 * Copyright 2015 Hewlett-Packard Development Company, L.P.
 * Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
 */

/**
 * @module display-collection
 */
define([
    'backbone',
    'underscore'
], function(Backbone, _) {

    // When we don't know the count for a value (because it is in the selected values collection but not the parametric
    // collection) use null instead
    var UNKNOWN_COUNT = null;

    // Transforms an array of selected values into an array of values collection model attributes
    function attributesForUnknownCountValues(values) {
        return _.map(values, function(value) {
            return {id: value, count: UNKNOWN_COUNT, selected: true};
        });
    }

    /**
     * The attributes set on each model in a [ValuesCollection]{@link module:display-collection~ValuesCollection}.
     * @typedef module:display-collection~ValuesCollection.ValueModelAttributes
     * @property {string} id The value name
     * @property {number} count The number of documents with the current search or null if we don't have that information
     */
    /**
     * Collection for storing the parametric values associated with a single parametric field.
     * @constructor
     * @name module:display-collection~ValuesCollection
     * @extends {Backbone.Collection}
     */
    var ValuesCollection = Backbone.Collection.extend({
        comparator: function(model) {
            // If count is null this evaluates to -0
            return -model.get('count');
        }
    });

    /**
     * The attributes set on each [DisplayModel]{@link module:display-collection~DisplayModel}.
     * @typedef module:display-collection~DisplayModel.DisplayModelAttributes
     * @property {string} id The field name
     * @property {string} displayName A "prettified" friendly name for the field
     * @property {boolean} selected Whether the user has selected the value
     * @property {boolean} selected Whether the user has selected the value
     */
    /**
     * The model for the [DisplayCollection]{@link module:display-collection}, representing a parametric field. The values
     * for the field are stored in the fieldValues property.
     * @constructor
     * @name module:display-collection~DisplayModel
     * @property {module:display-collection~ValuesCollection} fieldValues
     * @extends {Backbone.Model}
     */
    var DisplayModel = Backbone.Model.extend({
        initialize: function(attributes, options) {
            this.fieldValues = new ValuesCollection(options.initialValues);
        }
    });

    /**
     * The attributes expected on models in the parametricCollection.
     * @typedef module:display-collection~ParametricCollectionAttributes
     * @property {string} name The field name
     * @property {Array.&lt;{value: string, count: number}>} values The values and associated document counts for the field
     */
    /**
     * @typedef module:display-collection~DisplayCollection.DisplayCollectionOptions
     * @property {Backbone.Collection} parametricCollection The collection which fetches the parametric fields and values
     * which match the current search
     * @property {module:selected-values-collection~SelectedValuesCollection} selectedParametricValues The collection which tracks which parametric
     * values have been selected by the user
     */
    /**
     * Combines the parametric values selected by the user with the fields and values returned by the server in order
     * to back a view of parametric values relevant to a search. Once a parametric value has been selected (and added to the
     * selected parametric values collection), it should not be removed until the user deselects it, even if they search for
     * something else.
     * &lt;p>This is designed to be a read only view on the underlying collections and should not be modified externally.
     * @name module:display-collection~DisplayCollection
     * @param {Array} models Must be the empty array due to restrictions in Backbone Collection
     * @param {module:display-collection~DisplayCollectionOptions} options
     * @constructor
     * @extends Backbone.View
     */
    return Backbone.Collection.extend(/** @lends module:display-collection~DisplayCollection.prototype */{
        comparator: 'displayName',
        model: DisplayModel,

        initialize: function(models, options) {
            this.parametricCollection = options.parametricCollection;
            this.selectedParametricValues = options.selectedParametricValues;

            this.createModels = this.getResolvedDisplayModels;

            this.listenTo(this.selectedParametricValues, 'add', this.onSelectedValueAdd);
            this.listenTo(this.selectedParametricValues, 'remove', this.onSelectedValueRemove);
            this.listenTo(this.selectedParametricValues, 'reset', this.onReset);
            this.listenTo(this.parametricCollection, 'reset', this.onReset);

            Array.prototype.push.apply(models, this.createModels());
        },

        onSelectedValueAdd: function(selectedModel) {
            var field = selectedModel.get('field');
            var value = selectedModel.get('value');
            if (value) {
                var valueModelAttributes = {id: value, displayValue: selectedModel.get('displayValue'), count: UNKNOWN_COUNT, selected: true};
                var fieldModel = this.get(field);

                if (fieldModel) {
                    var valueModel = fieldModel.fieldValues.get(value);

                    if (valueModel) {
                        valueModel.set('selected', true);
                    } else {
                        fieldModel.fieldValues.add(valueModelAttributes);
                    }
                } else {
                    var attributes = {
                        id: field,
                        displayName: selectedModel.get('displayName'),
                        totalValues: 0,
                        type: 'Parametric'
                    };

                    this.add(new DisplayModel(attributes, {initialValues: [valueModelAttributes]}));
                }
            }
        },

        onSelectedValueRemove: function(selectedModel) {
            var field = selectedModel.get('field');
            var value = selectedModel.get('value');
            if (value) {
                var parametricModel = this.parametricCollection.get(field);

                var inParametricCollection = parametricModel &amp;&amp; _.any(parametricModel.get('values'), function (item) {
                        return value === item.value;
                    });

                var model = this.get(field);

                if (inParametricCollection) {
                    model.fieldValues.get(value).set('selected', false);
                } else {
                    // Only remove the value model if the value is not in the parametric collection
                    if (model.fieldValues.length &lt;= 1) {
                        this.remove(model);
                    } else {
                        model.fieldValues.remove(value);
                    }
                }
            }
        },

        onReset: function() {
            this.reset(this.createModels());
        },

        /**
         * Returns an array of display models based on the current state of the parametric and selected values collections.
         * @private
         * @return {module:display-collection~DisplayModel[]}
         */
        getResolvedDisplayModels: function() {
            var selectedFields = this.selectedParametricValues.toFieldsAndValues();

            var newModels = this.parametricCollection.map(function(parametricModel) {
                var field = parametricModel.get('id');

                // Track the selected values for this field so we don't consider them twice
                var selectedField = selectedFields[field];
                var selectedValues = selectedField ? selectedField.values : [];

                var initialValues = _.map(parametricModel.get('values'), function(item) {
                    var value = item.value;
                    var oldSelectedValuesLength = selectedValues.length;
                    selectedValues = _.without(selectedValues, value);
                    // If the length has changed after calling _.without, the value must have been selected
                    var isSelected = oldSelectedValuesLength !== selectedValues.length;
                    return {id: item.value, displayValue: item.displayValue, count: item.count, selected: isSelected};
                })
                // Handle any selected values which are not in the parametric collection
                    .concat(attributesForUnknownCountValues(selectedValues));

                // Delete the selected field from the map so we don't consider it twice
                delete selectedFields[field];

                var attributes = {
                    id: parametricModel.get('id'),
                    displayName: parametricModel.get('displayName'),
                    type: parametricModel.get('type'),
                    totalValues: parametricModel.get('totalValues')
                };

                return new DisplayModel(attributes, {initialValues: initialValues});
            }, this);

            // Handle any selected fields which were not present in the parametric collection
            newModels = newModels.concat(_.chain(selectedFields)
                .map(function (data, field) {
                    return data.range ? null : new DisplayModel({id: field, displayName: data.displayName, type: data.type, totalValues: null}, {
                            initialValues: attributesForUnknownCountValues(data.values)
                        });
                })
                .compact()
                .value()
            );

            return newModels;
        }
    });

});
</pre>
	</article>
</section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Copyright 2015 Hewlett-Packard Development Company, L.P. Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
		on Tue May 16th 11:34 2017 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>
